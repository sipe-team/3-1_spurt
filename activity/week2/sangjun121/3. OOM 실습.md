# OOM λ°μƒ μ–΄ν”λ¦¬μΌ€μ΄μ… μ‹¤μµ

## 1. κ°μ”

OOM λ°μƒ μ–΄ν”λ¦¬μΌ€μ΄μ…μ— K6λ΅ λ¶€ν•ν…μ¤νΈλ¥Ό μ‹¤ν–‰ν•κ³ , μΈ΅μ •λ λ©”νΈλ¦­μ„ Grafanaλ¥Ό ν†µν•΄ μ‚΄ν΄λ³΄κ³  μ›μΈμ„ νμ•…ν•λ” κ³Όμ •μ„ κΈ°μ ν•μ€μµλ‹λ‹¤.π“

<br>

## 2. μμ  μ†κ°

- `external/countries`λ΅ GET μ”μ²­ μ‹, Okhttp3 λΌμ΄λΈλ¬λ¦¬λ΅ μ™Έλ¶€μ— μλ” JSON νμΌμ„ μ½μ–΄μ„ κ° λ‚λΌ λ° λ‚λΌμ— ν•΄λ‹Ήν•λ” μ‘λ‹µμ½”λ“λ¥Ό λ°ν™ν•λ” μμ μ…λ‹λ‹¤.

<br>

### K6 λ¶€ν• ν…μ¤νΈ μ„¤μ •

```java
import http from "k6/http";

export const options = {
    vus: 50,
    duration: '60s',
    noConnectionReuse: true,
}

export default async function() {
    const url = 'http://localhost:8080/external/countries';
    call(url)    
}

async function call(url) {
    http.get(url);
}
```

- λ³„λ„μ sleep λ©”μ†λ“ μ‹¤ν–‰μ—†μ΄, `/external/countries` μ—”λ“ν¬μΈνΈλ΅ 60μ΄κ°„ 50λ…μ κ°€μƒμ‚¬μ©μκ°€ λ™μ‹μ— Requestλ¥Ό μν–‰ν•λ„λ΅ μ„¤μ •ν•μ€μµλ‹λ‹¤.  `noConnectionReuse: true` μ„¤μ •μ„ ν†µν•΄ κ° μ”μ²­μ— λ€ν•΄ μƒλ΅μ΄ Request Connectionμ„ μ‚¬μ©ν• μμ μ…λ‹λ‹¤.

<br>

## 2. ν”„λ΅μ νΈ ν™κ²½μ„¤μ •

![image.webp](/.asset/sangjun121/week2-3-1.png)

- Run > Edit configuration > Bulid and run > modify options > `Xmx128m` μ„¤μ •
- `Xmx128m` μ„¤μ •β“
    - JVM(Java Virtual Machine)μ— ν• λ‹Ήν•  μ μλ” μµλ€ ν™ λ©”λ¨λ¦¬ ν¬κΈ°λ¥Ό 128MBλ΅ μ ν•ν•λ” μ„¤μ •μ…λ‹λ‹¤.
    - λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ΄ ν•΄λ‹Ή μ ν•μ„ μ΄κ³Όν•λ ¤ ν•λ©΄, **OutOfMemoryError**κ°€ λ°μƒν•  μ μμµλ‹λ‹¤.
    
<br>

## 3. ν…μ¤νΈ κ²°κ³Ό

### 1. K6 λ©”νΈλ¦­ μ§€ν‘

- μ΄ Running Timeμ€ 1m 30sλ΅ μΈ΅μ •λμ—κ³ , μ„¤μ • duration μ΄ν›„ λ€κΈ° μ¤‘μ΄λ Requestλ“¤μ΄  `request timeout` λμ–΄ μ”μ²­ μ‹¤ν¨λ λ΅κ·Έλ¬Έμ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

![image.webp](/.asset/sangjun121/week2-3-2.png)

**http_req_failed**

- 41.53%μ μ”μ²­ μ‹¤ν¨μ¨μ„ ν™•μΈν•  μ μλ‹¤.

<br>

### 2. Intelli Jμ Local Profiler - CPU and Memory Live chart

![image.webp](/.asset/sangjun121/week2-3-3.png)

- OomApplication PID 5576λ²μ CPU and Memory Live chart ν™•μΈ

![image.webp](/.asset/sangjun121/week2-3-4.png)

- λ¶€ν•ν…μ¤νΈ μ‹¤ν–‰ μ „, CPU and Memory Live chart

![image.webp](/.asset/sangjun121/week2-3-5.png)

- λ¶€ν•ν…μ¤νΈ μ‹¤ν–‰ ν›„, CPU and Memory Live chart
- μ‹¤ν–‰ ν›„, CPU μ‚¬μ©λ‰μ΄ μ¦κ°€ν•κ³ , HEAP λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ΄ ν• λ‹ΉμΉμΈ 128MBμ— μ„λ°•ν•¨μ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

<br>

### 3. Grafana λ€μ‹λ³΄λ“ ν™•μΈν•κΈ°

1. **Request μ§€ν‘**
    
    ![image.webp](/.asset/sangjun121/week2-3-6.png)
    
    - ν•΄λ‹Ή Request μ§€ν‘λ¥Ό μ‚΄ν΄λ³΄λ©΄, 23:47:30μ— μ‹μ‘λ κΈ‰κ²©ν• μ”μ²­ μ¦κ°€κ°€ μμ—κ³ , μ΄λ” 23:48:30κΉμ§€ μ§€μ†λ ν›„ κ°μ†ν•λ” ν¨ν„΄μ„ λ³΄μ€μµλ‹λ‹¤.
    - **Request Duration**
        - μ”μ²­ μ‹κ°„μ΄ μ μ°¨ κΈΈμ–΄μ§€λ” κ²½ν–¥μ΄ κ΄€μ°° λμ—κ³ , μ΄λ” JVMμ΄ λ©”λ¨λ¦¬ λ¶€μ΅± μƒνƒμ— λΉ μ§€λ©΄μ„ μ„±λ¥μ΄ μ €ν•λμ—λ‹¤κ³  νλ‹¨λμ—μµλ‹λ‹¤.
        - λ”°λΌμ„, ν•΄λ‹Ή μ‹κ°„λ™μ• Heap λ©”λ¨λ¦¬μ μƒνƒμ™€ GCμ¶”μ„Έμ— λ€ν•΄ μ‚΄ν΄ λ³΄μ•μµλ‹λ‹¤.
    
2. **Heap λ©”λ¨λ¦¬ μ§€ν‘**
    
    ![image.webp](/.asset/sangjun121/week1-3-3.png)
    
    - μ΄ν•΄λ¥Ό λ•κΈ° μ„ν•΄, Heap λ©”λ¨λ¦¬μ κµ¬μ΅°λ¥Ό ν•¨κ» μ²¨λ¶€ν•μ€μµλ‹λ‹¤.
    
    ![image.webp](/.asset/sangjun121/week2-3-8.png)
    
    - ν•΄λ‹Ή Grafana λ€μ‹λ³΄λ“λ¥Ό λ³΄λ©΄, G1 Eden μμ—­μ λ©”λ¨λ¦¬μ— **Minor GCκ°€ μν–‰λμ–΄ κ°μ†λκ³ , μ΄λ”** Suvivor μμ—­μΌλ΅ μ΄λ™ν•κ³ , **Major GCκ°€ μν–‰λμ–΄** Old μμ—­μΌλ΅ κ°μ²΄λ“¤μ΄ λ„μ λλ” κ²ƒμΌλ΅ λ³΄μ…λ‹λ‹¤.
    - μ•„λμ GCμ¶”μ„Έμ™€ μΆ…ν•©ν•μ—¬ λ¶„μ„ν•΄λ³΄λ„λ΅ ν•κ² μµλ‹λ‹¤.

1. **GC(Garbage Collector) μ¶”μ„Έ**
    
    ![image.webp](/.asset/sangjun121/week2-3-9.png)
    
    - GC μΉ΄μ΄νΈλ” Old Generationμ κ°μ²΄λ¥Ό μ •λ¦¬ν•λ” Major GCμ—μ„ κ°€μ¥ λΉλ²ν•κ² λ°μƒν•λ” κ²ƒμΌλ΅ λ³΄μ…λ‹λ‹¤. λν•, GCλ΅ μΈν• STWλ„ Major GCμ λΉ„μ¤‘μ΄ ν° κ²ƒμΌλ΅ λ³΄μ…λ‹λ‹¤.
    - Heap λ©”λ¨λ¦¬ λ‚΄λ¶€μ μ‚¬μ©λ‰κ³Ό GC countλ¥Ό μΆ…ν•©ν•΄λ³΄μ•μ„ λ•, Young Genκ³Ό Suvivorμ—μ„ λ°μƒν•λ” minor GCλ” μƒλ€μ μΌλ΅ μ†λ„κ°€ λΉ λ¥΄κ³  λΉλ²ν•κ² λ°μƒν•κΈ° λ•λ¬Έμ—, Eden μμ—­μ—μ„μ GCλ” λΉ λ¥΄κ² μν–‰λμ–΄, κ°μ²΄κ°€ κ°μ†ν•λ” μ¶”μ„Έλ΅ λ³΄μ…λ‹λ‹¤. λ”λ¶μ–΄, Suvivor μμ—­μ κ°μ²΄λ“¤μ€ μΌμ • νμμ GCλ¥Ό ν†µκ³Όν• ν›„ Old GenμΌλ΅ λ„μ–΄κ°€κΈ° λ•λ¬Έμ—, μ¦κ°€ν•λ” μ¶”μ„Έλ΅ λ³΄μ…λ‹λ‹¤.
    - λν•, μ΄λ΅ μ μΌλ΅λ” Minor GCμ— λΉ„ν•΄, **Major GCλ” λ°μƒ λΉλ„κ°€ μ μ€λ°, μ‹¤μ  μ§€ν‘λ” GC Countκ°€ λ” λΉλ²ν•κ² λ°μƒν•κ³  μλ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤!**
        - μ΄μ— λ€ν• ν•΄μ„μΌλ΅, μ”μ²­μ κΈ‰μ¦μΌλ΅ μΈν•΄ μΌμ‹μ  κ°μ²΄κ°€ λΉ λ¥΄κ² μƒμ„±λκ³ , Young β†’ Oldλ΅ λ„μ•„κ°€λ” κ³Όμ •μ—μ„ Oldμ— κ°μ²΄κ°€ λΉ λ¥΄κ² μ±„μ›μ΅μ„ κ²ƒμΌλ΅ λ³΄μ…λ‹λ‹¤.
        - μ΄λ΅ μΈν•΄ Major GCλ” Old Generationμ—μ„ λ©”λ¨λ¦¬λ¥Ό ν•΄μ ν•λ ¤κ³  μ‹λ„ν•μ§€λ§, μ°Έμ΅°κ°€ λ‚¨μ•„ μλ” κ°μ²΄λ“¤μ΄ λ§μ•„μ„ μ¶©λ¶„ν• λ©”λ¨λ¦¬κ°€ ν™•λ³΄λμ§€ λ»ν•κ³ , κ²°κµ­ OutOfMemoryErrorκ°€ λ°μƒν• κ²ƒμΌλ΅ λ³΄μ…λ‹λ‹¤.
    
<br>

## 4. λ¬Έμ  ν•΄κ²°

### 1. Intelli J Profilerλ¥Ό ν†µν•΄ λ³‘λ©μ§€μ  μ°ΎκΈ°

(ν¬λ™λ‹μ μ›μΈ λ¶„μ„ κΈ€μ„ μ½κ³  μ¶”κ°€ν•μ€μµλ‹λ‹¤.)

![image.webp](/.asset/sangjun121/week2-3-10.png)

- μΈν…”λ¦¬μ μ΄μ ν”„λ΅νμΌλ§μ„ ν†µν•΄, `CountryClient.getExternalCountry λ©”μ†λ“` μ—μ„ λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ΄ λ§μ€ κ²ƒμΌλ΅ νμ•…λμ—μµλ‹λ‹¤.

![image.webp](/.asset/sangjun121/week2-3-11.png)

- ν•΄λ‹Ή λ©”μ†λ“λ¥Ό μ½μ–΄λ³΄λ©΄, μ™Έλ¶€ APIλ΅ μ”μ²­μ„ μƒμ„±ν•  λ•λ§λ‹¤, μƒλ΅μ΄ `OkHttpClient` κ°μ²΄λ¥Ό μƒμ„±ν•΄μ£Όκ³  μμµλ‹λ‹¤.

```java
var client = new OkHttpClient();
```

- μ΄λ΅ μΈν•΄ 50λ…μ μ‚¬μ©μμ λ™μ‹ μ”μ²­ λ¶€ν• μ‹, κ° μ”μ²­λ§λ‹¤ κ°μ²΄κ°€ μƒμ„±λμ–΄ OOMμ΄ λ°μƒν•μ€μμ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

<br>

### 2. κ°μ„  μ½”λ“

- OkHttpClient κ°μ²΄λ¥Ό μ¬μ‚¬μ©ν•λ„λ΅ μ½”λ“ κµ¬μ΅°λ¥Ό λ³€κ²½ν•μ€μµλ‹λ‹¤.

```java
@Component
public class CountryClient {
    
    private final OkHttpClient client;
    private final ObjectMapper objectMapper = new ObjectMapper();
    private final TypeFactory typeFactory = objectMapper.getTypeFactory();
    private static final String API_URL = "...";

// μμ •ννΈ
    public CountryClient() {
        this.client = new OkHttpClient(); // OkHttpClientλ¥Ό ν• λ²λ§ μƒμ„±ν•©λ‹λ‹¤.
    }
    
    public List<ExternalCountryResponse> getExternalCountry() {
        try {
            var request = new Request.Builder().url(API_URL).build();
            var response = client.newCall(request).execute().body();
            if (response == null) {
                return List.of();
            }
            return objectMapper.readValue(response.string(), typeFactory.constructCollectionType(List.class, ExternalCountryResponse.class));
        } catch (IOException e) {
//            log.warn("Error fetching response");
            return List.of();
        }
    }
```

<br>

### 3.  μμ • μ΄ν›„ ν…μ¤νΈ

![image.webp](/.asset/sangjun121/week2-3-12.png)

- μμ • μ΄ν›„, λ™μΌν• K6 λ¶€ν•ν…μ¤νΈ ν›„, **http_req_failed** μ§€ν‘κ°€ 0%κ°€ λ κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤.
