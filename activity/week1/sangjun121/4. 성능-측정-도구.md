# 성능 측정 도구

부하 테스트 도구에 대해 살펴보고, 해당 도구들의 장단점과 각 기술의 비교를 작성하였습니다. 

## 1. Apache JMeter

**개요**

Apache의 Jmeter는 순수 JAVA로 작성된 성능테스트 프레임워크로, 초기에는 Web 관련 부하테스트를 목적으로 개발되었으나, 현재 거의 모든 어플리케이션과 프로토콜을 테스트 할 수 있습니다.  

<br>

**스크립트 언어**

CLI는 XML로 작성 후, JAVA로 실행합니다.   

<br>

**지원 프로토콜**

웹 HTTP, HTTPS, SOAP/REST 웹서비스, FTP, MAIL(SMTP, POP3, IMAP), 등 다양한 프로토콜을 제공합니다.     

<br>

**장점**

- 최근까지도 많은 릴리즈와 개선 사항을 통해 고도로 유지 및 관리되고 있습니다.
- 대부분의 프로토콜을 지원하기 때문에, 기본 함수 및 다른 플러그인을 사용하여 한곳에서 모든 성능테스트가 가능합니다.
- Spring과 통합하기 위한 다양한 플러그인을 제공하여, 연동하기 쉽습니다.
- GUI, CLI를 모두 제공합니다.
- 스크립트 레코딩를 제공합니다.
- 분산 부하 테스트 기능을 기본적으로 제공합니다.
  
<br>

![image.png](/.asset/sangjun121/week1-4-1.png)
    
**부하분산 테스트란?**    
- 테스트에 사용하는 가상 사용자의 수를 늘리고, 다른 부하 생성기를 사용하여 다중 인스턴스를 작동시키는 것을 의미합니다.     
- JMeter의 경우, Controller 노드와 Worker 노드들을 분리하여 분산 부하 테스트를 진행할 수 있습니다.
    

<br>

**단점**

- 기본적으로, 성능 테스트 툴은 필요한 만큼의 Request를 실행할 수 있어야 합니다.  이때, 동시 사용자를 만드는 상황에서, JMeter는 각 사용자에 대해 별도의 스레드를 할당하는, 스레드 기반 모델입니다.
- 이렇게 Thread를 할당할 때마다 리소스가 필요하기 때문에, 한대의 Worker에서 사용할 수 있는 사용자 수가 매우 한정적입니다.
    - 일반적으로 하나의 Worker에서 최대 1000개까지 Thread 생성 가능
- GUI모드에서 많은 메모리를 사용합니다.(LOCUST와 비교했을때, GUI모드의 메모리 사용량이 28배 많다.)
- JVM 위에서 작동하기 때문에, 성능이 느릴 수 있습니다.
- GUI모드를 사용하도록 설계 되었기 때문에, 스크립트 작성 방법에 대한 문서가 부족하고, 구현의 복잡성이 있습니다.

<br>

## 2. Locust

**개요**

Python으로 작성된 성능 테스트 프레임 워크로, Python을 이용하여 성능 스크립트를 작성합니다.

<br>


**스크립트 언어**

Python으로 작성할 수 있습니다. 

<br>


**지원 프로토콜**

기본적으로 HTTP/HTTPS 프로토콜을 지원하며, 사용자 정의를 통해 다른 프로토콜도 사용할 수 있습니다.

<br>


**장점**

- Locust는 이벤트 및 비동기 접근 방식을 기반으로 합니다. 이 덕분에 Request를 생성할 때, Gevent 구현을 통해 단일 시스템에서 수천 명의 동시 사용자를 테스트할 수 있습니다.
- **또한, Event 기반 구현 확장성**이 뛰어나기 때문에 빠르게 성장하고 있습니다.
    - **위 내용의 자세한 설명**
        - Event 기반 구현이란, 시스템에서 특정 사건이나 이벤트가 발생할 때마다 특정 작업을 수행하는 방식의 모델입니다. 이벤트 기반 구현이 비동기 환경에 좋은 이유는, 동시에 여러 작업을 처리하는 비동기 환경에서, 이벤트 루프가 모든 작업을 관리하기 때문에, 많은 스레드나 프로세스를 생성할 필요가 없어집니다. 이로 인해 컨텍스트 스위칭,등 여러 오버헤드가 줄어들고 성능이 개선됩니다.
- Python으로 스크립트를 작성하기 때문에, 다른 도구들과 다르게 훨씬 빠르고 간편하게 스크립트를 작성할 수 있습니다. 또한 코드 기반 스크립트이기 때문에, UI없이도 테스트를 쉽게 수정할 수 있습니다.
- 마찬가지로 코드 기반이기 때문에, 스크립트를 Git으로 관리하여 변경 사항 관리 및 협업에 유리합니다.

<br>


**단점**

CLI환경 바로 테스트 가능하지 않고, 브라우저로 접속 가능하도록 서버를 띄어야 합니다.

<br>


## 3. K6

**개요**

K6는 2017년에 출시된, Grafana Labs가 운영하는 오픈소스 성능 테스트 도구입니다.

<br>


**스크립트 언어**

자바스크립트로 작성할 수 있습니다.

<br>


**장점**

- 자바 스크립트를 사용하여, 스크립트 작성이 편리합니다. (Jmeter의 XML 스크립트와 비교하면, 코드 가독성 측면에서 매우 편리)
- **요청 생성시, 적은 메모리 사용하기 때문에, 더 많은 가상 사용자와 부하를 생성할 수 있습니다. K6는 단일 인스턴스 기준 초당 최대 30만 요청까지 가능합니다.**
- GUI가 없습니다. GUI가 없기 때문에 성능 테스트 도중 리소스 오버헤드가 일어나지 않습니다.

<br>


**단점**

- GUI를 제공하지만, JMeter처럼 모든 기능을 제공하지 않으며, 기본적으로 스크립트 코드를 작성해야 합니다.
- 브라우저에서 네이트브하게 수행할 수 없습니다. 앞서 K6의 장점인, 리소스 오버헤드를 위해 Trade Off한 사항입니다.
- 부하 분산 테스트를 제공하지 않습니다.
    - 대용량 트래픽이나, 분산테스트를 진행하려면, K8s와 K6 Operator과 같은 외부 서비스를 연결하여 함께 사용해야 합니다.

<br>


## 4. nGrinder

**개요**

![image.png](/.asset/sangjun121/week1-4-2.png)

네이버에서 만든 스크립트 기반 부하테스트 툴로, **테스트 관리를 위한 Controller와 부하 생성을 위한 Agent로 구성됩니다.**

<br>


**스크립트 언어**

**Groovy와 Jython로 작성할 수 있습니다.**

<br>


**장점**

- 스크립트 이름, 도메인주소, 요청을 보낼 API정도만 입력해줘도 완성도 있는 뼈대 스크립트 코드를 작성해줍니다.
- 단순히 부하만 발생시키는 것 뿐만 아니라, 스크립트를 통해서 다양한 시나리오를 테스트 할 수 있습니다.
- 다중 지역 에이전트를 이용하여, 글로번 부하 테스트 환경을 구축할 수 있습니다.

<br>


**단점**

- **Jython에 대한 선수 지식이 없다면,** 스크립트를 작성하기에 **어려울 수 있습니다.**
- 테스트 스크립트 IDE를 지원하지 않습니다.

<br>


**성능 측정 옵션**

nGrinder에서 성능 테스트 시, 선택할 수 있는 옵션에 대해 알아보겠습니다.

![image.png](/.asset/sangjun121/week1-4-3.webp)

- Vuser 설정
- 테스트 스크립트 지정
- Duration: 테스트 실행시간을 지정합니다.
- Run Count: 테스트 횟수를 지정합니다.
- Enable Ramp-up: 시간에 따라 점차 Vuser를 늘려가면서 부하를 늘려가는 방식으로, 해당 옵션을 통해 설정할 수 있습니다.

<br>


**결과 지표**

nGrinder에서 성능 테스트 시, 확인 할 수 있는 결과 지표에 대해 알아보겠습니다.

![image.png](/.asset/sangjun121/week1-4-4.webp)

- TPS: 초당 처리 가능 요청
- Peak TPS: 가장 높았던 처리율
- Mean Test Time: 평균 응답 시간
- Executed Tests: 총 실행 테스트 수
- Successful Tests: 성공 테스트 수
- Errors:  실패 테스트 수

<br>


### 결과 간단 분석

![image.png](/.asset/sangjun121/week1-4-5.png)

- 해당 성능 테스트 결과를 보면, Vuser가 점진적으로 증가하여 19분이 넘어갈수록 Error가 증가함을 확인 할 수 있습니다. 해당 사용자 수부터 API에 대한 점진적인 성능 개선 시작하고, 임계 지점에서 설정한 Latency 값을 만족하도록 성능을 개선해야 합니다.

<br>


## 참고 래퍼런스

[Jmeter vs. Locust 무엇을 써야 할까?](https://giljae.medium.com/jmeter-vs-locust-%EB%AC%B4%EC%97%87%EC%9D%84-%EC%8D%A8%EC%95%BC-%ED%95%A0%EA%B9%8C-1d1e0769c08)     
[ngrinder 성능테스트 [서버 부하 테스트]](https://giron.tistory.com/83)   
[k6 vs JMeter, 어느 성능 테스트 도구를 써야 할까?](https://medium.com/uniquegood/k6-vs-jmeter-%EC%96%B4%EB%8A%90-%EC%84%B1%EB%8A%A5-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%8F%84%EA%B5%AC%EB%A5%BC-%EC%8D%A8%EC%95%BC-%ED%95%A0%EA%B9%8C-8381aa13f5e6)     
[Comparing k6 and JMeter for load testing](https://grafana.com/blog/2021/01/27/k6-vs-jmeter-comparison/)     
[내가 만든 서비스는 얼마나 많은 사용자가 이용할 수 있을까?](https://hyuntaeknote.tistory.com/11)     
[nGrinder](https://naver.github.io/ngrinder/)     
[nGrinder를 활용한 부하테스트](https://medium.com/naverfinancial/ngrinder%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EB%B6%80%ED%95%98%ED%85%8C%EC%8A%A4%ED%8A%B8-a8b1676cba6b)
