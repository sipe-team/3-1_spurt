# 소프트웨어 성능 테스트(Software performance testing)

- 성능테스트란, 특정 작업 부하 하에서 시스템이 **응답성과 안정성 측면에서 어떻게 작동하는지**를 확인하기 위해 수행되는 테스트입니다.     
  [위키피디아](https://en.wikipedia.org/wiki/Software_performance_testing)

## 1. 테스트의 측정 지표

- 테스트 시 중요 판단 지표는 다음과 같습니다.
    - **응답성(responsiveness): 시스템이 사용자 응답에 얼마나 빠르게 반응하는지 측정**
    - **안정성(stability): 높은 부하환경에서도 시스템이 오류없이 안정적으로 유지되는지 확인**
- 이 외에도, **확장성**(더 많은 사용자나 요청을 처리할 수 있는 능력), **신뢰성**(오류 발생 가능성), **자원 사용량, 가용성**과 같은 품질 속성 값도 평가의 대상이 됩니다.   
  ![image.png](/.asset/sangjun121/week1-2-1.png)
    - **확장성**: 요구되는 시스템의 성능에 따라 동적으로 서버 구성이 변경되고, 시스템 처리 능력을 최적화할 수 있는 상태
      - 수직확장(Scale Up)
        - 단일 서버의 스펙을 더 좋은 것으로 업그레이드 하는 것을 의미합니다. 예를 들어 하나의 머신에서 메모리나 CPU를 늘리는 경우는 수직확장에 해당합니다.
        - 하지만 단일 컴퓨터 파워에는 한계가 존재하고, 단일 서버로 서비스를 운영하는 경우 **단일 장애점(SPOF)**를 갖는다는 한계가 있습니다.
        - 따라서 일반적으로, 수직 확장은 데이터 일관성, 무결성이 중요한 데이터베이스 서버에 적합한 방식입니다.
    
      - 수평확장(Scale Out)
        - 여러대의 서버를 추가적으로 설치하는 방식을 의미합니다.
        - 수평확장은 클러스터링 작업에 추가 비용이 발생한다는 단점이 있지, 이론적으로 확장에 제한이 없고, 단일 장애점을 가지지 않아 장애내성이 있습니다.
        - 이러한 장점 덕분에 사용자수를 예측하기 어려운 요즘 날의 서비스들은, 사용자의 수요에 따라 유연하게 서버를 확장, 축소하는 수평확장을 사용합니다.
        
  - **가용성**: 시스템이 서비스를 정상적으로 제공할 수 있는 상태를 의미합니다.

    $$
    uptime / uptime+downtime
    $$
        
    - uptime(정상가동시간), downtime(사용불가시간)
    - 가용성 표현에 대해 예를 들어 쉽게 설명하면, **가용성이 99.95%라는 의미**는 **약 1년에 4시간 22분의 다운 타임을 갖는다**는 의미입니다.
        - 금융이나 의료와 같은 다운타임의 영향이 큰 서비스의 경우, 다운 타임 허용시간이 매우 짧아야 합니다.
    - 가용성을 높이기 위한 중요 조치는, 시스템 확장으로 단일 장애점(SPOF)를 제거하고, 동일한 처리 능력을 가진 다른 인스턴스로 대체 될 수 있어야 합니다.
<br>

## 2. 테스트 종류

테스트의 종류는 아래 목적이나 시나리오에 따라 구분 할 수 있습니다.

![image.png](/.asset/sangjun121/week1-2-2.png)

### Smoke testing(스모크 테스트)

- 최소한의 부하를 주어 시스템이 정상적으로 동작하는지 확인하는 테스트입니다.
- **Smoke Test는 안정성(stability)을 확인하는 테스트**
    - 아래 **Sanity Test(정합성 테스트)와의 차이점 참고**

### Load testing(부하 테스트)

- 가장 기본적인 테스트로, 목표 값에 해당되는 부하를 견딜 수 있는지 확인하는 테스트입니다.
- 여기서 부하(workload)는 크게, 특정 시간 동안 수행되는 예상 동시 사용자수 또는 트랜잭션 수 일 수 있습니다.
- 중요한 비즈니스 트랜잭션의 응답 시간을 측정하는 데 도움을 주며, 데이터베이스, 애플리케이션 서버 등의 병목 현상을 식별하는 데도 유용합니다.

### **Stress testing (스트레스 테스트)**

- 시스템의 용량 한계(최대 처리 용량)를 파악하기 위해 수행하는 테스트입니다.
- 부하테스트는 목표치에 대한 테스트 였다면, 스트레스 테스트는 최대치에 해당하는 테스트
- 부하테스트를 먼저 진행하고 수행하는 것이 좋다. 병목구간을 파악하기 위해 부하테스트를 먼저 진행한다.
- 극한의 부하 하에서 시스템의 견고성을 평가하고, 부하 수준이 예상보다 높아지더라도 시스템이 정상적으로 작동할 수 있는지 판단하는 데 도움을 준다.
- 부하테스트를 진행하고 실행하는 것이 좋다!

### **Soak testing (침수 테스트)**

- 장기간의 지속적인 예상 부하 하에서 시스템이 안정적으로 작동할 수 있는지 테스트
- 평균 사용률로 일정부하를 지속적으로 주며, 시스템이 문제되는 지점을 확인
- Endurance Test (내구 테스트)라고도 한다.
- 주요 파악 사항
    - 메모리 누수 및 성능 저하 문제를 파악하기 위해, 메모리 사용량을 모니터링
    - 시간이 지나도 처리량과 응답시간이 초기와 동일하게 유지되는지 확인

### **Spike testing (스파이크 테스트)**

- 매우 많은 사용자 수의 부하를 갑자기 증가 혹은 감소시켜 시스템의 반응을 관찰하는 테스트
- 성능 저하, 시스템 오류, 또는 급격한 부하 변화에 대한 시스템의 처리 능력을 평가하는 데 사용
- 상황 예시: 수강신청시 사용자 급증

### **Breakpoint testing (임계점 테스트)**

- **Stress테스트와 유사하게, 시스템 용량의 한계를 확인하기 위해 점진적인 부하 테스트. 시스템이 사전에 정해진 오류조건에 도달하는지 모니터링한다.**
- 시스템이 필요한 사양, 서비스 수준 계약(SLA)아래에서 최대 용량을 파악하는 데 도움을 준다. 이는 클라우드 환경에서 스케일링 전략을 결정하는데 도움이 된다.

### **Configuration testing (구성 테스트)**

- 구성 변경의 효과를 평가하기 위해 수행되는 테스트
- 일반적으로 로드 밸런싱과 같은 다양한 방법을 실험하는 테스트

### **Isolation testing (격리 테스트)**

- 문제를 고립시키고 해당 문제 영역을 확인하는 테스트
- 시스템 문제를 재현하기 위해 문제 발생시와 동일한 테스트를 반복 실행한다.

<br>

## 3. 테스트 진행 전 서비스 수준 목표(SLO) 설정

- 테스트를 진행하기 전, 서비스의 상황에 맞게 서비스의 성능 목표를 설정하는 것이 중요합니다. 예를 들어, 금융이나 의료 서비스와 같은 다운타임의 영향이 큰 경우, 처리량(Throughput)을 고려하여 서비스의 가용성을 유지하는 것이 중요 목표가 될 수 있습니다.

### Latency**를 중점으로 둔 SLO**

- GET 호출의 90프로는 1ms 이내에 완료해야 한다.
- 앞서 살펴 보았듯이, 서브 시스템의 Latency 총합이 전체 시스템의 Latency가 되기 때문에, 가장 Latency가 큰 서브 시스템부터 성능을 개선하는 것이 중요합니다.

### **Throughput를 중점으로 둔 SLO**

- 기본적으로 RPS(Request Per Second)의 계산법은 다음과 같습니다.

$$
RPS = (요청 수) / (총 시간(초))
$$

- RPS를 구하는 또 다른 방법으로는, 가상 사용자(Virtual Users)와 대기시간(Latency)를 이용하는 방법이 있습니다.
    
$$
가상사용자(Virtual Users) = (RPS)*(초당  Latency)
$$
    
- 따라서, 부하테스트 시, 특정 수의 RPS를 시뮬레이션 하려면 어플리케이션의 Latency와 설정 RPS를 통해 가장 사용자 수를 유도할 수 있습니다.
  
- 이제 실제 예시에서 Throughput을 중점으로 SLO를 설정하는 방법에 대해 알아보겠습니다.
    1. 먼저 서비스의 1일 접속자수인 DAU(Daily Active Users)를 파악합니다. 이에 더불어 1명 당 평균 접속횟수를 구해야 합니다. (해당 예시에서는 DAU 5만명, 1명당 평균 접속횟수를 20회로 가정하겠습니다.)
       
    2. 1일 평균 접속 횟수에 대한 피크 트래픽 배율을 설정합니다. 일반적으로 2~3배를 곱하여, 1일 최대 피크 수를 예측합니다. (해당 예시에서는 1일 평균 피크 트래픽 배율을 3배로 가정하겠습니다.)
       
    3. 마지막으로 안전계수를 설정합니다. 여기서 안전계수는 얼만큼 넉넉하게 프로비저닝을 할 것인지를 의미합니다. (해당 예시에서는 3배로 가정하겠습니다.)
       
    4. 해당 지표들을 바탕으로 위 수식을 이용하여 RPS를 구하면, (DAU * 1인당 평균 접속 횟수/ 하루(86400초)) * 피크 트래픽 배율 * 안전계수로 약 100RPS가 나옵니다. 따라서 해당 서비스의 SLO는 100RPS로, 이를 목표로 성능개선을 실시해야 합니다.

<br>

## 4. 성능테스트의 메트릭

- 메트릭이란, 하드웨어나 소프트웨어 성능 측정을 위한 **측정 수치값**을 의미합니다.

성능테스트에서 측정하는 메트릭은 다음과 같습니다.

1. 사용된 CPU의 양을 표현하는, CPU 용량의 백분율
2. 작업 요청을 처리하는 동안 컴퓨터 기본 메모리 사용량
3. Response Time
    - 요청 전송 시간 + 요청시간 + 응답시간
    - 사용자가 요청을 보내고 응답을 받을 때까지의 시간을 의미합니다.
4. 평균 로드 시간
5. 처리량(Throughput)
6. 평균 대기 시간
    - Latency + Wait time(시스템이 요청을 처리하는데 걸리는 시간)
    - Wait time는 **Latency와 다르게 시스템의 내부 작업 시간을 포함하여 측정합니다.**
7. 네트워크 대역폭
8. RPS(초당 요청 수)
9. Error Rate (에러율)
10. 트랙젝션
    - 성능테스트에서의 트랜젝션은 데이터베이스의 상태를 변화시키기 위해서 수행하는 작업의 단위를 의미합니다.
   
<br>

## 5. 부하테스트의 단계

부하 테스트의 순차적인 흐름에 대해 간단하게 작성하였습니다.

- 먼저, 비결합된 개별 컴포넌트에 대해 부하테스트를 진행합니다.
    - 작은 단위의 컴포넌트에 대해 테스트를 진행하면서, 각 컴포넌트 내의 병목현상을 빠르게 발견하고 조치하는 것이 가능합니다.
      
- 다음으로, 내부 서비스에 대해 부하테스트를 진행합니다.
    - 로그 기록 서비스와 같은 높은 처리량이 요구되는 서비스나, 결제와 금융과 같은 중요 내부 서비스에 대해 테스트를 진행합니다.
      
- 외부서비스에 대해 부하테스트를 진행합니다.
    - 서비스의 중요 내부서비스 외에, 타 플랫폼 및 서비스와 연동된 외부 서비스에 대해 테스트를 진행합니다.
      
- 마지막으로 전체 스택에 대해 부하테스트를 진행합니다.
    - 각 컴포넌트들의 상호작용을 알고 전체적인 서비스 스택의 병목지점을 파악하기 위한 테스트를 진행합니다.

<br>

## 참고. 테스트 비교 2가지

### 1️⃣ **Sanity Test(정합성 테스트)와 Smoke Test의 차이**

![image.png](/.asset/sangjun121/week1-2-3.webp)

1. 목표의 차이
    - **Smoke Test는 안정성(stability)을 확인하는 테스트입니다. 주요 기능이 제대로 작동하는지 확인하며 제품의 안정성을 유지하기 위해 본 테스트 전, 한번 확인하는 작업입니다.**
    - 이와 반대로 **Sanity Test는 합리성(rationality)을 검증하는 테스트 입니다.**
      
2. 담당자의 차이
    - **Smoke Test는 개발자 및 테스터에 의해 수행되지만, Sanity Test의 경우 테스터에 의해 수행됩니다.**
      
3. 테스트 검증 목표의 차이
    - **Smoke Test는 시스템의 주요 기능들(critical functionalities)이 제대로 작동하는지 확인하는 반면, Sanity Test는 버그 수정과 같은 새로운 기능이 제대로 작동하는지 확인한다.**
      
4. 범위의 차이
    - **Smoke Test는 전체 시스템의 end to end를 확인하는 반면, Sanity Test는 특정 컴포넌트만 확인한다.**

<br>

### 2️⃣ **Stress testing (스트레스 테스트)의** **Breakpoint testing (임계점 테스트) 차이**

- 앞서 부하테스트의 종류에 대해 공부하면서, **Stress testing와 Breakpoint testing** 모두 시스템의 한계를 측정하는 테스트라는 점에서 유사하다고 느꼈습니다. 따라서 해당 챕터는 두 테스트의 차이에 대해 기술합니다.

![image.png](/.asset/sangjun121/week1-2-4.png)

![image.png](/.asset/sangjun121/week1-2-5.png)

- 작업 부하의 관점에서는 두 테스트 모두 최대 한계치에 대해 테스트 한다는 접근 방식은 동일합니다.
- 하지만, **Stress testing는 첫번째 병목 지점을 찾는 것에 중점을 둡니다. 일반적으로 배포 이전이나 개발 초기 단계에서 수행되는 테스트**입니다. 즉, 품질 보증 작업을 개발 초기로 옮겨 빠르게 문제를 발견하고 조치하는 Shift-Left 방식에서 주로 사용합니다.
  
- 반면에, **Breakpoint testing은 시스템 전체가 문제 없이 처리할 수 있는 최대 부하를 파악하고 시스템 내부에서 가장 느린 요소가 무엇인지 확인하는 것에 중점을 둡니다**. 따라서 통합된 전체 환경을 대상으로 하며, 어느 부분이 확장 및 최적화가 필요한지 분석하는데 중점을 둡니다.

<br>

## 참고 래퍼런스
 
[grafana - Load test types](https://grafana.com/docs/k6/latest/testing-guides/test-types/)     
[Smoke Test에 대하여](https://m.blog.naver.com/PostView.nhn?blogId=wisestone2007&logNo=220868861867&proxyReferer=https:%2F%2Fwww.google.com%2F)       
[Difference between stress test and breakpoint test](https://stackoverflow.com/questions/69722534/difference-between-stress-test-and-breakpoint-test)      
[Sanity Testing Vs. Smoke Testing – Difference Between Them](https://www.guru99.com/smoke-sanity-testing.html)        
[새 Azure Load Testing 사용자를 위한 주요 개념](https://learn.microsoft.com/ko-kr/azure/load-testing/concept-load-testing-concepts)
